@{
    ViewData["Title"] = "Mark Attendance";
}
@model List<appdev_final_req.Models.AttendanceViewModel>

@{
    var eventId = (int)ViewBag.EventId;
    bool isSaved = ViewBag.Saved ?? false;
}

<style>
    :root[data-bs-theme='light'] {
        --page-bg: #fff;
        --text-color: #212529;
        --card-bg: #fff;
        --table-header-bg: #e3f2fd;
        --table-border: #dee2e6;
        --success: #d1e7dd;
        --danger: #f8d7da;
    }

    :root[data-bs-theme='dark'] {
        --page-bg: #212529;
        --text-color: #fff;
        --card-bg: #1e1e2f;
        --table-header-bg: #2c3e50;
        --table-border: #6aa5f8;
        --success: #1e3e30;
        --danger: #4a1e1e;
    }

    body {
        font-family: 'Poppins', sans-serif;
        background-color: var(--page-bg);
        color: var(--text-color);
    }

    .table {
        background-color: var(--card-bg);
        color: var(--text-color);
        border: 1px solid var(--table-border);
    }

    .table th {
        background-color: var(--table-header-bg);
        color: var(--text-color);
        border: 1px solid var(--table-border);
    }

    .table td {
        background-color: var(--card-bg);
        color: var(--text-color);
        border: 1px solid var(--table-border);
    }

    .table-success td {
        background-color: var(--success) !important;
    }

    .table-danger td {
        background-color: var(--danger) !important;
    }

    .present-checkbox {
        transform: scale(1.5);
    }

    .search-bar {
        max-width: 250px;
    }
</style>

<h1 class="text-center">📝 Mark Attendance</h1>
<p class="text-center">Mark attendance for <strong>@ViewBag.EventTitle</strong></p>

@if (!isSaved)
{
    <div id="attendanceSection">
        <form id="searchForm" method="get">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="d-flex search-bar">
                    <input class="form-control me-2" type="search" name="search" placeholder="Search" value="@Context.Request.Query["search"]" />
                    <button class="btn btn-outline-primary" type="submit">🔍</button>
                </div>
            </div>
        </form>

        <form id="attendanceForm" method="post">
            <input type="hidden" name="eventId" value="@eventId" />

            <table class="table table-bordered rounded-2" id="attendanceTable">
                <thead>
                    <tr>
                        <th onclick="sortAttendanceTable(0)">Member ID <span id="sortIcon0"></span></th>
                        <th onclick="sortAttendanceTable(1)">Member <span id="sortIcon1"></span></th>
                        <th class="text-center" onclick="sortAttendanceTable(2)">
                            Present ✔️
                            <span id="sortIcon2"></span>
                            <input type="checkbox" id="selectAll" class="form-check-input ms-2" />
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @for (int i = 0; i < Model.Count; i++)
                    {
                        <tr>
                            <td>@Model[i].MemberId</td>
                            <td>@Model[i].FullName</td>
                            <td class="text-center">
                                <input type="hidden" name="attendanceList[@i].MemberId" value="@Model[i].MemberId" />
                                <input class="form-check-input present-checkbox" type="checkbox" name="attendanceList[@i].IsPresent" value="true" @(Model[i].IsPresent ? "checked" : "") />
                            </td>
                        </tr>
                    }
                </tbody>
            </table>

            <div class="d-flex justify-content-between mt-4">
                <button class="btn btn-success px-4" type="submit">Save</button>
                <a asp-controller="Attendance" asp-action="List" class="btn btn-secondary px-4">Cancel</a>
            </div>
        </form>

        @if (ViewBag.TotalPages > 1)
        {
            <nav class="mt-3">
                <ul class="pagination justify-content-center" id="paginationControls">
                    <li class="page-item @(ViewBag.CurrentPage == 1 ? "disabled" : "")">
                        <button class="page-link" onclick="loadPage(@(ViewBag.CurrentPage - 1))">Previous</button>
                    </li>
                    @for (int i = 1; i <= ViewBag.TotalPages; i++)
                    {
                        <li class="page-item @(ViewBag.CurrentPage == i ? "active" : "")">
                            <button class="page-link" onclick="loadPage(@i)">@i</button>
                        </li>
                    }
                    <li class="page-item @(ViewBag.CurrentPage == ViewBag.TotalPages ? "disabled" : "")">
                        <button class="page-link" onclick="loadPage(@(ViewBag.CurrentPage + 1))">Next</button>
                    </li>
                </ul>
            </nav>
        }
    </div>
}
else
{
    <h5 class="mt-4">✅ Present Members</h5>
    <table class="table table-bordered table-success">
        <thead><tr><th>Member ID</th><th>Member</th></tr></thead>
        <tbody>
            @foreach (var m in Model.Where(x => x.IsPresent))
            {
                <tr><td>@m.MemberId</td><td>@m.FullName</td></tr>
            }
        </tbody>
    </table>

    <h5 class="mt-4">❌ Absent Members</h5>
    <table class="table table-bordered table-danger">
        <thead><tr><th>Member ID</th><th>Member</th></tr></thead>
        <tbody>
            @foreach (var m in Model.Where(x => !x.IsPresent))
            {
                <tr><td>@m.MemberId</td><td>@m.FullName</td></tr>
            }
        </tbody>
    </table>

    <div class="mt-4 text-center">
        <a asp-controller="Attendance" asp-action="List" class="btn btn-secondary px-4">Back to Events</a>
    </div>
}

@section Scripts {
    <script>
        let sortDir = {}, lastCol = null;

        function sortAttendanceTable(col) {
            const table = document.getElementById("attendanceTable").getElementsByTagName('tbody')[0];
            const rows = Array.from(table.rows);
            sortDir[col] = !sortDir[col];

            rows.sort((a, b) => {
                if (col === 2) {
                    return sortDir[col] ? (b.cells[col].querySelector('input')?.checked - a.cells[col].querySelector('input')?.checked)
                                        : (a.cells[col].querySelector('input')?.checked - b.cells[col].querySelector('input')?.checked);
                }
                const aText = a.cells[col].innerText.trim().toLowerCase();
                const bText = b.cells[col].innerText.trim().toLowerCase();
                return sortDir[col] ? aText.localeCompare(bText) : bText.localeCompare(aText);
            });

            rows.forEach(row => table.appendChild(row));

            if (lastCol !== null && lastCol !== col) document.getElementById(`sortIcon${lastCol}`).innerHTML = '';
            document.getElementById(`sortIcon${col}`).innerHTML = sortDir[col] ? '▲' : '▼';
            lastCol = col;
        }

        document.getElementById("selectAll")?.addEventListener("change", e => {
            document.querySelectorAll(".present-checkbox").forEach(cb => cb.checked = e.target.checked);
        });

        function loadPage(page) {
            const search = document.querySelector('input[name="search"]').value;
            const eventId = @eventId;

            fetch(`/Attendance/MarkAttendance?id=${eventId}&page=${page}&search=${encodeURIComponent(search)}`, {
                headers: { "X-Requested-With": "XMLHttpRequest" }
            })
            .then(res => res.text())
            .then(html => {
                const temp = document.createElement('div');
                temp.innerHTML = html;
                const newSection = temp.querySelector('#attendanceSection');
                document.getElementById('attendanceSection').innerHTML = newSection.innerHTML;
                attachEvents();
            });
        }

        function attachEvents() {
            document.getElementById("selectAll")?.addEventListener("change", e => {
                document.querySelectorAll(".present-checkbox").forEach(cb => cb.checked = e.target.checked);
            });
        }

        attachEvents();
    </script>
}
